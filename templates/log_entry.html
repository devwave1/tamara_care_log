<!DOCTYPE html>
<html>
<head>
    <title>Log Tamara's Activity</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        form { max-width: 600px; margin: auto; background: #f8f8f8; padding: 1px 20px 20px 20px; border-radius: 8px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input, select, textarea {
            width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;
        }
        textarea { height: 60px; }
        input[type="submit"] { margin-top: 20px; padding: 10px 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .media-preview { 
            margin-top: 10px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 10px; 
        }
        .media-preview img, .media-preview video { 
            max-width: 200px; 
            max-height: 200px; 
            object-fit: cover; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        #media { display: none; }
        .btn-add-more { margin-top: 10px; }
        .media-item { position: relative; }
        .remove-btn {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
        }
        .media-item:hover .remove-btn { display: block; }
    </style>
</head>
<body>
    {% include 'header.html' %}

    <div class="header">
        <h2>Log New Activity for Tamara</h2>
        <p>Logged in as: {{ session['carer_name'] }}</p>
    </div>

    <div class="mb-3 position-relative">
  <label for="quickFind" class="form-label">Quick Find</label>
  <input type="search" id="quickFind" class="form-control"
         placeholder="Type: nappy, wee, poo, sleep, gym, smoothie…"
         autocomplete="off">
  <div id="quickFindResults"
       class="list-group position-absolute w-100 shadow"
       style="z-index:1000; max-height: 280px; overflow:auto; display:none"></div>
  </div>


    <form id="logForm" method="post" enctype="multipart/form-data">
        <label for="activity_name">Activity:</label>
        <select name="activity_name" id="activity_name" required>
            <option value="">Select an Activity</option>
            <option value="Mood">Mood</option>
            <option value="Sleep Quality">Sleep Quality</option>
            <option value="Nap Taken">Nap Taken</option>
            <option value="Toilet Tries">Toilet Tries</option>
            <option value="Accidents">Accidents</option>
            <option value="Bath/Shower Completed">Bath/Shower Completed</option>
            <option value="Teeth Brushed">Teeth Brushed</option>
            <option value="Walking Ability">Walking Ability</option>
            <option value="Fine Motor Skills">Fine Motor Skills</option>
            <option value="Gross Motor Skills">Gross Motor Skills</option>
            <option value="Communication Level">Communication Level</option>
            <option value="Fluid Intake">Fluid Intake</option>
            <option value="Meltdowns">Meltdowns</option>
            <option value="Sensory Sensitivities">Sensory Sensitivities</option>
            <option value="Exercise / Physical Activity">Exercise / Physical Activity</option>
            <option value="Menstrual Cycle">Menstrual Cycle</option>
            <option value="Food">Food</option>
            <option value="Message for Careers">Message for Careers</option>
            <option value="Health / Medical">Health / Medical</option>
        </select>

        <label for="value-select">Value:</label>
        <div id="value-container">
            <select name="value" id="value-select" style="display: none;"></select>
            <input type="text" name="value" id="value-text">
            <input type="hidden" name="calculated_value" id="calculated_value">
        </div>

        <label for="notes">Notes (optional):</label>
        <textarea name="notes" id="notes"></textarea>

        <!-- AAC / GAS extras (shown only for Communication Level) -->
        <div id="aacExtras" style="display:none; margin-top:12px; padding:10px; border:1px dashed #ccc; border-radius:6px;">
          <div class="mb-2">
            <label class="form-label">GAS & AAC Prompting level</label>
            <select name="aac_prompting_level" class="form-select">
              <option value="">—</option>
              <option>Independent</option>
              <option>Expectant/thoughtful pause</option>
              <option>Facial expression</option>
              <option>Body language</option>
              <option>Observation/comment</option>
              <option>Visual prompt/gestural cue</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Words used (if any)</label>
            <input name="aac_words_used" class="form-control" placeholder="yes, no, stop, go…">
          </div>

          <!-- Keep this whole block inside #aacExtras -->
          <input type="hidden" name="aac_goal_no" id="aac_goal_no" value="1">

          <div class="mb-2">
            <label class="form-label">Attainment (pick goal + level)</label>
            <select name="aac_attainment_level" id="attainment_picker" class="form-select" required>

              <optgroup label="Goal 1 — Linguistic/Social: Requests single words">
                <option value="2" data-goal="1" data-desc="+2 Much greater than expected — Tamara will use single words on their device to ask for a desired item, independently, by the end of a 4-week trial.">
                  Goal 1 • +2 — Much greater than expected
                </option>
                <option value="1" data-goal="1" data-desc="+1 Greater than expected — Tamara will use single words on their device to ask for desired items when provided with an expectant/thoughtful pause, by the end of a 4-week trial.">
                  Goal 1 • +1 — Greater than expected
                </option>
                <option value="0" data-goal="1" data-desc="0 Expected — Tamara will use single words on their device to ask for desired items when their communication partner makes a comment as a prompt (e.g. “it looks like you want something”), by the end of a 4-week trial.">
                  Goal 1 • 0 — Expected
                </option>
                <option value="-1" data-goal="1" data-desc="-1 Less than expected — Tamara will use single words on their device to ask for desired items when provided with a gestural cue (e.g. tapping on device), by the end of a 4-week trial.">
                  Goal 1 • -1 — Less than expected
                </option>
                <option value="-2" data-goal="1" data-desc="-2 Baseline — Tamara currently looks at the item she wants and the communication partner most of the time.">
                  Goal 1 • -2 — Baseline
                </option>
              </optgroup>

              <optgroup label="Goal 2 — Operational: 2-hit selection + navigate back">
                <option value="2" data-goal="2" data-desc="+2 Much greater than expected — Tamara will make a 2-hit selection to select a word and navigate back to home (back/core button) when given a visual prompt, by the end of a 4-week trial.">
                  Goal 2 • +2 — Much greater than expected
                </option>
                <option value="1" data-goal="2" data-desc="+1 Greater than expected — Tamara will touch two buttons (make a 2-hit selection) to select a word, independently, by the end of a 4-week trial.">
                  Goal 2 • +1 — Greater than expected
                </option>
                <option value="0" data-goal="2" data-desc="0 Expected — Tamara will touch two buttons (make a 2-hit selection by navigating through a folder) to select a word when given a visual prompt (e.g. pointing), by the end of a 4-week trial.">
                  Goal 2 • 0 — Expected
                </option>
                <option value="-1" data-goal="2" data-desc="-1 Less than expected — Tamara will consistently touch a button on the screen once (make a 1-hit selection) to select a word when given a visual/verbal prompt, by the end of a 4-week trial.">
                  Goal 2 • -1 — Less than expected
                </option>
                <option value="-2" data-goal="2" data-desc="-2 Baseline — Tamara sometimes (inconsistently) attempts to touch the AAC system when prompted.">
                  Goal 2 • -2 — Baseline
                </option>
              </optgroup>

              <optgroup label="Goal 3 — Strategic/Social: Gain partner’s attention with AAC">
                <option value="2" data-goal="3" data-desc="+2 Much greater than expected — Tamara will gain partner’s attention by picking up the AAC device and bringing it to partner (may also vocalise or touch).">
                  Goal 3 • +2 — Much greater than expected
                </option>
                <option value="1" data-goal="3" data-desc="+1 Greater than expected — Tamara will gain partner’s attention by expressing symbols on the AAC device and looking at communication partner.">
                  Goal 3 • +1 — Greater than expected
                </option>
                <option value="0" data-goal="3" data-desc="0 Expected — Tamara will gain partner’s attention by reaching out to the AAC device and looking at communication partner.">
                  Goal 3 • 0 — Expected
                </option>
                <option value="-1" data-goal="3" data-desc="-1 Less than expected — Tamara will gain partner’s attention by coming up to communication partner and looking/touching/vocalising/gesturing.">
                  Goal 3 • -1 — Less than expected
                </option>
                <option value="-2" data-goal="3" data-desc="-2 Baseline — Tamara will gain partner’s attention by looking at them and/or looking at the item she wants.">
                  Goal 3 • -2 — Baseline
                </option>
              </optgroup>

            </select>
            <div id="attainment_help" class="muted" style="margin-top:6px;" aria-live="polite">
              +2 Much greater than expected — Tamara will use single words on their device to ask for a desired item, independently, by the end of a 4-week trial.
            </div>
          </div>


          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="also_create_aac" name="also_create_aac" checked>
            <label class="form-check-label" for="also_create_aac">
              Also save to GAS & AAC tracker
            </label>
          </div>

          <div class="form-check mt-1">
            <input class="form-check-input" type="checkbox" id="also_make_prompt_log" name="also_make_prompt_log" checked>
            <label class="form-check-label" for="also_make_prompt_log">
              Also add “GAS & AAC Prompting Level” entry to classic logs
            </label>
          </div>
        </div>

        <script>
        (function(){
          const activitySel = document.getElementById('activity_name');
          const aacExtras   = document.getElementById('aacExtras');
          const picker      = document.getElementById('attainment_picker');
          const help        = document.getElementById('attainment_help');
          const goalHidden  = document.getElementById('aac_goal_no');

          function syncAttainmentHelpAndGoal(){
            if (!picker) return;
            const opt = picker.options[picker.selectedIndex];
            if (!opt) return;
            help.textContent   = opt.getAttribute('data-desc') || '';
            goalHidden.value   = opt.getAttribute('data-goal') || '1';
          }

          function toggleAAC(){
            const isComm = (activitySel.value === 'Communication Level');
            aacExtras.style.display = isComm ? 'block' : 'none';

            // Only require the picker when Communication Level is chosen
            if (picker) picker.required = isComm;

            // Keep goal + helper text in sync if visible
            if (isComm) syncAttainmentHelpAndGoal();
          }

          if (picker) picker.addEventListener('change', syncAttainmentHelpAndGoal);
          activitySel.addEventListener('change', toggleAAC);

          // run once on load
          toggleAAC();
          if (picker) syncAttainmentHelpAndGoal();
        })();
        </script>



        <label for="activity_datetime">Time of Activity:</label>
        <input type="datetime-local" name="activity_datetime" id="activity_datetime"
               value="{{ current_datetime }}" required>

        <label for="duration">Duration:</label>
        <select name="duration" id="duration" required>
            <option value="5">5 minutes</option>
            <option value="15">15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">1 hour</option>
            <option value="120">2 hours</option>
            <option value="150">2.5 hours</option>
            <option value="180">3 hours</option>
            <option value="210">3.5 hours</option>
            <option value="240">4 hours</option>
            <option value="270">4.5 hours</option>
            <option value="300">5 hours</option>
            <option value="240">Half Day</option>
            <option value="480">Full Day</option>
            <option value="180">All Morning</option>
            <option value="180">All Afternoon</option>
            <option value="480">All Night</option>
            <option value="720">All Day</option>
        </select>

        <label>Upload Media (optional):</label>
        <input type="file" name="media" id="media" accept="image/*,video/*,.heic" multiple>
        <button type="button" id="addMoreBtn" class="btn btn-secondary btn-add-more">Add More Media</button>
        <div class="media-preview" id="media-preview"></div>

        <input type="hidden" name="value_type" id="value_type">

        <input type="submit" value="Log Entry" class="btn btn-primary">
    </form>

    <script>
const activityValues = {
  "Mood": [
    { label: "Upset", value: "1" },
    { label: "Low", value: "2" },
    { label: "Okay", value: "3" },
    { label: "Cheerful", value: "4" },
    { label: "Elated", value: "5" }
  ],
  "Sleep Quality": [
    { label: "Poor", value: "1" },
    { label: "Fair", value: "2" },
    { label: "Good", value: "3" },
    { label: "Excellent", value: "4" }
  ],
  "Nap Taken": [
    { label: "Yes", value: "1" },
    { label: "No", value: "0" }
  ],
  "Toilet Tries": [
    { label: "Yes Both", value: "4" },
    { label: "Yes Poo", value: "3" },
    { label: "Yes Wee", value: "2" },
    { label: "Tried No Success", value: "1" }
  ],
  "Accidents": [
    { label: "Wet", value: "1" },
    { label: "Soiled", value: "2" },
    { label: "Both", value: "3" }
  ],
  "Bath/Shower Completed": [
    { label: "Yes", value: "1" },
    { label: "No", value: "0" }
  ],
  "Teeth Brushed": [
    { label: "Yes", value: "1" },
    { label: "No", value: "0" }
  ],
  "Walking Ability": [
    { label: "Needs Help", value: "1" },
    { label: "Independent", value: "2" }
  ],
  "Fine Motor Skills": [
    { label: "Poor", value: "1" },
    { label: "Fair", value: "2" },
    { label: "Good", value: "3" }
  ],
  "Gross Motor Skills": [
    { label: "Poor", value: "1" },
    { label: "Fair", value: "2" },
    { label: "Good", value: "3" }
  ],
  "Communication Level": [
    { label: "No communication No observable communication or response", value: "1", description: "No observable communication or response" },
    { label: "Passive communication Not initiating communication; prompt dependent", value: "2", description: "Not initiating communication; prompt dependent" },
    { label: "Minimal communication, not directed at others Body language / eye gaze / vocalisations not directed at others", value: "3", description: "Body language / eye gaze / vocalisations not directed at others" },
    { label: "Directed communication without back-and-forth Gestures, expressions or vocalisations directed at others, but limited exchange", value: "4", description: "Gestures, expressions or vocalisations directed at others, but limited exchange" },
    { label: "Back and forth communication Engages in two-way interaction using multiple communication methods", value: "5", description: "Engages in two-way interaction using multiple communication methods" }
  ],
  "Fluid Intake": [
    { label: "50ml", value: "1" },
    { label: "100ml", value: "2" },
    { label: "200ml", value: "3" },
    { label: "300ml", value: "4" },
    { label: "500ml+", value: "5" }
  ],
  "Meltdowns": [
    { label: "None", value: "0" },
    { label: "Mild", value: "1" },
    { label: "Moderate", value: "2" },
    { label: "Severe", value: "3" }
  ],
  "Sensory Sensitivities": [
    { label: "Sound", value: "1" },
    { label: "Light", value: "2" },
    { label: "Touch", value: "3" },
    { label: "Movement", value: "4" }
  ],
  "Exercise / Physical Activity": [
    { label: "Yoga (Low Intensity)", value: "1.5" },
    { label: "Walking (Light)", value: "2.0" },
    { label: "Park Play (Light-Moderate)", value: "2.5" },
    { label: "Riding Bike (Moderate)", value: "3.5" },
    { label: "Dancing (Moderate-High)", value: "4.2" },
    { label: "Swimming (Moderate-High)", value: "4.0" },
    { label: "Gym Workout (Park Equipment)", value: "4.5" },
    { label: "Trampolining (High Intensity)", value: "5.0" }
  ],
  "Menstrual Cycle": [
    { label: "Spotting", value: "1" },
    { label: "Medium", value: "2" },
    { label: "Heavy", value: "3" }
  ],
  "Food": [
    { label: "Protein", value: "1" },
    { label: "Vegetables", value: "1" },
    { label: "Carbohydrate", value: "1" },
    { label: "Fruit", value: "1" },
    { label: "Cereals", value: "1" },
    { label: "Other", value: "1" }
  ],
  "Message for Careers": [
    { label: "Message", value: "1" }
  ],
  "Health / Medical": [
    { label: "Medication Taken", value: "1" },
    { label: "Doctor's Appointment", value: "1" },
    { label: "Hospital Visit", value: "1" },
    { label: "Large Bloating", value: "1" },
    { label: "Less Bloated", value: "1" },
    { label: "Raynauds Purple Hands or Feet", value: "1" },
    { label: "Raynauds Red Hands or Feet", value: "1" },
    { label: "Dribbling allot", value: "1" },
    { label: "Dribbling Moderate", value: "1" },
    { label: "Dribbling less", value: "1" },
    { label: "Other", value: "1" }
  ]
};

const activitySelect = document.getElementById("activity_name");
let valueSelect = document.getElementById("value-select");
const valueText = document.getElementById("value-text");
const valueTypeInput = document.getElementById("value_type");
const calculatedValueInput = document.getElementById("calculated_value");
const mediaInput = document.getElementById("media");
const mediaPreview = document.getElementById("media-preview");
const addMoreBtn = document.getElementById("addMoreBtn");
const logForm = document.getElementById("logForm");

let selectedFiles = []; // Clear on page load to prevent accumulation

// ✅ helper to sync hidden fields
function syncMultiFields() {
  const selectedOptions = Array.from(valueSelect.selectedOptions || []);
  const labels = selectedOptions.map(opt => opt.textContent);
  valueTypeInput.value = labels.join(", ");

  if (activitySelect.value === "Exercise / Physical Activity") {
    const values = selectedOptions.map(opt => parseFloat(opt.value)).filter(v => !isNaN(v));
    const mean = values.length > 0 ? (values.reduce((s, v) => s + v, 0) / values.length).toFixed(2) : "";
    calculatedValueInput.value = mean;
    valueText.value = mean;
  } else if (activitySelect.value === "Food") {
    const count = selectedOptions.length;
    calculatedValueInput.value = count > 0 ? count : "";
    valueText.value = count > 0 ? count : "";
  } else {
    calculatedValueInput.value = "";
    valueText.value = selectedOptions.map(opt => opt.value).join(",");
  }
}


function initializeValueSelect() {
    const selected = activitySelect.value;
    const options = activityValues[selected];

    valueSelect.innerHTML = "";
    valueSelect.removeAttribute("multiple");

    if (options) {
        if (selected === "Exercise / Physical Activity" || selected === "Food") {
            valueSelect.setAttribute("multiple", "multiple");
        }

        options.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.value;
            opt.textContent = item.label;
            valueSelect.appendChild(opt);
        });

        valueSelect.style.display = "block";
        valueSelect.name = "value";
        valueSelect.required = true;
        valueSelect.disabled = false;

        valueText.style.display = "none";
        valueText.name = "temp";
        valueText.required = false;
        valueText.disabled = true;

        const selectedOptions = Array.from(valueSelect.selectedOptions);
        const labels = selectedOptions.map(opt => opt.textContent);
        valueTypeInput.value = labels.join(", ");

        if (selected === "Exercise / Physical Activity") {
            const values = selectedOptions.map(opt => parseFloat(opt.value)).filter(v => !isNaN(v));
            const mean = values.length > 0 ? (values.reduce((sum, val) => sum + val, 0) / values.length).toFixed(2) : "";
            calculatedValueInput.value = mean;
            valueText.value = mean;
        } else if (selected === "Food") {
            const count = selectedOptions.length;
            calculatedValueInput.value = count > 0 ? count : "";
            valueText.value = count > 0 ? count : "";
        } else {
            calculatedValueInput.value = "";
            valueText.value = selectedOptions.map(opt => opt.value).join(",");
        }
    } else {
        valueSelect.style.display = "none";
        valueSelect.name = "temp";
        valueSelect.required = false;
        valueSelect.disabled = true;

        valueText.style.display = "block";
        valueText.name = "value";
        valueText.required = true;
        valueText.disabled = false;

        valueTypeInput.value = "text";
        calculatedValueInput.value = "";
        valueText.value = "";
    }
}

activitySelect.addEventListener("change", function () {
    initializeValueSelect();
    // ensure listener + initial sync on page load
    valueSelect.addEventListener("change", syncMultiFields);
    syncMultiFields();

    // Remove existing change listeners to prevent duplicates
    const newValueSelect = valueSelect.cloneNode(true);
    valueSelect.parentNode.replaceChild(newValueSelect, valueSelect);
    valueSelect = newValueSelect;

    valueSelect.addEventListener("change", function () {
        const selectedOptions = Array.from(valueSelect.selectedOptions);
        const labels = selectedOptions.map(opt => opt.textContent);
        valueTypeInput.value = labels.join(", ");

        if (activitySelect.value === "Exercise / Physical Activity") {
            const values = selectedOptions.map(opt => parseFloat(opt.value)).filter(v => !isNaN(v));
            const mean = values.length > 0 ? (values.reduce((sum, val) => sum + val, 0) / values.length).toFixed(2) : "";
            calculatedValueInput.value = mean;
            valueText.value = mean;
        } else if (activitySelect.value === "Food") {
            const count = selectedOptions.length;
            calculatedValueInput.value = count > 0 ? count : "";
            valueText.value = count > 0 ? count : "";
        } else {
            calculatedValueInput.value = "";
            valueText.value = selectedOptions.map(opt => opt.value).join(",");
        }
    });
});

initializeValueSelect();

mediaInput.addEventListener("change", async function (e) {
    const newFiles = Array.from(e.target.files);
    let totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
    const maxSize = 50 * 1024 * 1024; // 50MB to match server limit

    for (const file of newFiles) {
        if (file.size > maxSize) {
            alert(`File "${file.name}" exceeds 50MB. Please select a smaller file.`);
            continue;
        }
        if (totalSize + file.size > maxSize) {
            alert(`Total upload size exceeds 50MB. Please remove some files or select smaller ones.`);
            continue;
        }
        if (file.type.startsWith("image/") || file.name.toLowerCase().endsWith(".heic")) {
            console.log(`Resizing image: ${file.name}`);
            const resizedBlob = await resizeImage(file, 1024);
            selectedFiles.push(new File([resizedBlob], file.name, { type: "image/jpeg" }));
        } else {
            console.log(`Adding non-image file: ${file.name}`);
            selectedFiles.push(file); // Videos are not resized
        }
        totalSize += selectedFiles[selectedFiles.length - 1].size;
    }
    updatePreviews();
    mediaInput.value = '';
});

function updatePreviews() {
    mediaPreview.innerHTML = '';
    selectedFiles.forEach((file, index) => {
        const preview = document.createElement("div");
        preview.className = "media-item";
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.textContent = "×";
        removeBtn.title = "Remove";
        removeBtn.onclick = () => {
            selectedFiles.splice(index, 1);
            updatePreviews();
        };

        if (file.type.startsWith("image/") || file.name.toLowerCase().endsWith(".heic")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            preview.appendChild(img);
        } else if (file.type.startsWith("video/")) {
            const video = document.createElement("video");
            video.controls = true;
            const source = document.createElement("source");
            source.src = URL.createObjectURL(file);
            source.type = file.type;
            video.appendChild(source);
            preview.appendChild(video);
        }
        preview.appendChild(removeBtn);
        mediaPreview.appendChild(preview);
    });
}

addMoreBtn.addEventListener("click", function () {
    mediaInput.click();
});

// Resize image to maxWidth (keeps aspect ratio)
function resizeImage(file, maxWidth) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function (event) {
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement("canvas");
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, "image/jpeg", 0.7); // 70% quality
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });
}

logForm.addEventListener("submit", function (e) {
  e.preventDefault();
  syncMultiFields(); // final sync before submit

  const formData = new FormData(logForm);
  selectedFiles.forEach(file => {
    formData.append('media', file);
  });

  for (let [key, value] of formData.entries()) {
    console.log(`FormData: ${key} = ${value}`);
  }

  fetch('/log', {
    method: 'POST',
    body: formData
  }).then(response => {
    if (!response.ok) {
      if (response.status === 413) {
        throw new Error('Upload size exceeds 50MB. Please remove some files and try again.');
      }
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    window.location.href = response.url || '/log';
  }).catch(error => {
    console.error('Log Submission Error:', error);
    alert('Error logging entry: ' + error.message);
  });
});



    </script>

    <script>
// ---------- Hidden synonym tags (activities) ----------
const activitySynonyms = {
  "Toilet Tries": ["toilet","toileting","wc","loo","bathroom","pee","wee","urine","poo","poop","bowel","bm","number two","constipated","void"],
  "Accidents": ["accident","nappy","diaper","pull-up","pull up","wet","soiled","leak","leaking","urine","bm","stool","dirty"],
  "Menstrual Cycle": ["period","menstruation","spotting","pads","bleeding","change"],
  "Sleep Quality": ["sleep","slept","sleepy","tired","dozing","awake","woke"],
  "Nap Taken": ["nap","snooze","doze","asleep","car nap"],
  "Mood": ["mood","happy","smiley","cheerful","low","flat","upset","sad","elated","okay","ok","smiling","grumpy"],
  "Food": ["food","eat","ate","lunch","breakfast","dinner","meal","snack","smoothie","sandwich","soup","porridge","toasted","cereal"],
  "Exercise / Physical Activity": ["exercise","gym","walk","trampoline","trampolining","bike","ride","dance","park","play","swim","yoga","swing"],
  "Health / Medical": ["doctor","gp","medical","medication","hospital","bloating","raynauds","dribbling","clinic","appointment"],
  "Message for Careers": ["message","note","update","comment","info","heads up"],
  "Fluid Intake": ["water","drink","ml","hydration","fluids","sip","sips","bottle","cups"],
  "Sensory Sensitivities": ["sound","noise","light","touch","movement","sensory","overstimulated","sensitive"],
  "Fine Motor Skills": ["fine motor","hands","buttons","pencil","cutlery","dexterity"],
  "Gross Motor Skills": ["gross motor","walking","posture","balance","standing","movement"],
  "Walking Ability": ["walking","gait","mobility","independent","needs help"],
  "Bath/Shower Completed": ["bath","shower","hygiene","wash","clean"],
  "Teeth Brushed": ["teeth","brush","dental","oral care"]
};

// ---------- Hidden synonym tags (specific values) ----------
const valueSynonyms = {
  "Toilet Tries::Yes Wee": ["wee","pee","urine","peed"],
  "Toilet Tries::Yes Poo": ["poo","pooped","bm","bowel","stool","number two"],
  "Toilet Tries::Yes Both": ["both","wee and poo","urine and stool"],
  "Toilet Tries::Tried No Success": ["tried","no success","sat on toilet","no wee","no poo"],

  "Accidents::Wet": ["wet","wee","urine","leak"],
  "Accidents::Soiled": ["soiled","poo","bm","stool","feces","faeces"],
  "Accidents::Both": ["both","wet and soiled"],

  "Nap Taken::Yes": ["nap","asleep","slept","dozed"],
  "Nap Taken::No": ["no nap","awake"],

  "Mood::Upset": ["upset","angry","frustrated","teary"],
  "Mood::Low": ["low","flat","sad","down"],
  "Mood::Okay": ["ok","okay","fine","neutral"],
  "Mood::Cheerful": ["happy","smiley","cheerful","smiling"],
  "Mood::Elated": ["elated","excited","euphoric"],

  "Food::Protein": ["meat","fish","chicken","egg","tofu","protein"],
  "Food::Vegetables": ["veg","veggies","vegetables","salad","greens"],
  "Food::Carbohydrate": ["carb","rice","pasta","bread","potato"],
  "Food::Fruit": ["fruit","banana","apple","berries"],
  "Food::Cereals": ["cereal","porridge","muesli"],
  "Food::Other": ["smoothie","soup","snack","sandwich","toast"],

  "Fluid Intake::50ml": ["sip","sips","50ml","small drink"],
  "Fluid Intake::100ml": ["100ml"],
  "Fluid Intake::200ml": ["200ml"],
  "Fluid Intake::300ml": ["300ml"],
  "Fluid Intake::500ml+": ["500ml","bottle","lots of water","well hydrated"]
};

// ---------- Quick Find UI wiring ----------
const quickFind = document.getElementById('quickFind');
const quickFindResults = document.getElementById('quickFindResults');

function norm(s){ return (s||"").toLowerCase().trim(); }

// Build a simple search Candidates list on demand
function searchCandidates(q){
  const query = norm(q);
  if(!query) return [];

  const tokens = query.split(/\s+/);

  const candidates = [];

  // 1) Activity matches
  Object.keys(activityValues).forEach(act => {
    const actName = norm(act);
    let score = 0;

    // direct name hit
    if (actName.includes(query)) score += 4;

    // synonym hits
    (activitySynonyms[act] || []).forEach(tag => {
      if (norm(tag).includes(query)) score += 3;
      // token bonus
      tokens.forEach(t => { if (t && norm(tag).includes(t)) score += 1; });
    });

    // value-level matches
    const opts = activityValues[act];
    if (Array.isArray(opts)){
      // opts could be array of strings or {label,value}
      opts.forEach(opt => {
        const label = typeof opt === 'string' ? opt : (opt.label || opt.value || "");
        const shown = norm(label);
        if (shown.includes(query)) {
          candidates.push({
            type: 'value',
            activity: act,
            valueLabel: label,
            score: score + 5,
            reason: `matches value “${label}”`
          });
        }
        // value synonyms
        const vsKey = `${act}::${label}`;
        (valueSynonyms[vsKey] || []).forEach(tag => {
          if (norm(tag).includes(query)) {
            candidates.push({
              type: 'value',
              activity: act,
              valueLabel: label,
              score: score + 6,
              reason: `matches “${tag}”`
            });
          }
        });
      });
    }

    if (score > 0){
      candidates.push({
        type: 'activity',
        activity: act,
        score,
        reason: 'activity match'
      });
    }
  });

  // sort high score first, then prefer value-level suggestions
  candidates.sort((a,b) => (b.score - a.score) || ((a.type==="value")? -1:1));
  // de-dup by activity+valueLabel
  const seen = new Set();
  const unique = [];
  for (const c of candidates){
    const key = `${c.activity}::${c.valueLabel||""}`;
    if (!seen.has(key)){
      seen.add(key);
      unique.push(c);
    }
    if (unique.length >= 10) break; // top 10
  }
  return unique;
}

function renderResults(items){
  if(!items.length){
    quickFindResults.style.display = 'none';
    quickFindResults.innerHTML = '';
    return;
  }
  quickFindResults.innerHTML = items.map((it, idx) => {
    const title = it.type === 'value'
      ? `${it.activity} → ${it.valueLabel}`
      : it.activity;
    return `<button type="button"
                   class="list-group-item list-group-item-action"
                   data-idx="${idx}">
              ${title}
              <small class="text-muted"> ${it.reason}</small>
            </button>`;
  }).join('');
  quickFindResults.style.display = 'block';
}

let lastResults = [];

quickFind.addEventListener('input', (e) => {
  lastResults = searchCandidates(e.target.value);
  renderResults(lastResults);
});

quickFindResults.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-idx]');
  if(!btn) return;
  const pick = lastResults[Number(btn.dataset.idx)];
  applySuggestion(pick);
});

quickFind.addEventListener('keydown', (e) => {
  // Enter = apply top suggestion
  if (e.key === 'Enter' && lastResults.length){
    e.preventDefault();
    applySuggestion(lastResults[0]);
  }
});

function applySuggestion(sug){
  // 1) select activity
  activitySelect.value = sug.activity;
  activitySelect.dispatchEvent(new Event('change')); // will rebuild the value select

  // 2) if value suggestion, try to preselect value
  if (sug.type === 'value' && valueSelect){
    const wanted = norm(sug.valueLabel);
    Array.from(valueSelect.options).forEach(opt => {
      if (norm(opt.textContent) === wanted) opt.selected = true;
    });
    valueSelect.dispatchEvent(new Event('change'));
    valueSelect.scrollIntoView({behavior:'smooth', block:'center'});
    // optional flash
    valueSelect.style.boxShadow = '0 0 0 0.25rem rgba(13,110,253,.25)';
    setTimeout(()=> valueSelect.style.boxShadow = '', 1200);
  } else {
    // just scroll to the value area
    valueSelect.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // hide results
  quickFindResults.style.display = 'none';
}
</script>

<script>
(function () {
  const picker = document.getElementById('attainment_picker');
  const help = document.getElementById('attainment_help');

  function syncFromSelection() {
    const opt = picker.options[picker.selectedIndex];
    if (!opt) return;
    const desc = opt.getAttribute('data-desc') || '';
    help.textContent = desc;
  }

  picker.addEventListener('change', syncFromSelection);
  syncFromSelection();
})();
</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>