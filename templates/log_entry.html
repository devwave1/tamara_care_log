{% extends "header.html" %}
{% block content %}
<style>
        form { max-width: 600px; margin: auto; background: #f8f8f8; padding: 1px 20px 20px 20px; border-radius: 8px; }
        label { display: block; margin-top: 15px; font-weight: bold; }
        input, select, textarea {
            width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box;
        }
        textarea { height: 60px; }
        input[type="submit"] { margin-top: 20px; padding: 10px 20px; }
        .header { text-align: center; margin-bottom: 20px; }
        .media-preview { 
            margin-top: 10px; 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 10px; 
        }
        .media-preview img, .media-preview video { 
            max-width: 200px; 
            max-height: 200px; 
            object-fit: cover; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        #media { display: none; }
        .btn-add-more { margin-top: 10px; }
        .media-item { position: relative; }
        .remove-btn {
            display: none;
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            cursor: pointer;
        }
        .media-item:hover .remove-btn { display: block; }
</style>

    <!-- Quick AAC Reminder Banner (dismissible) -->
    <div class="alert alert-info alert-dismissible fade show" role="alert" style="background-color: #0dcaf0; color: #000; border: 3px solid #0aa2c0; font-weight: 600; margin: 20px; max-width: 1200px; margin-left: auto; margin-right: auto;">
        <h5 class="alert-heading mb-2">üì± Quick AAC Check - Focused Task Reminder</h5>
        <p class="mb-2"><strong>Remember:</strong> Use the Quick AAC Check page to log communication events quickly (10 seconds). This is a critical Focused Task for tracking Tamara's progress.</p>
        <a href="/quick/aac" class="btn btn-primary btn-sm mt-1" style="background-color: #000; border-color: #000;">Go to Quick AAC Check ‚Üí</a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

<div class="container-fluid mt-4">
    <div class="header">
        <h2>Log New Activity for Tamara</h2>
        <p>Logged in as: {{ session['carer_name'] }}</p>
    </div>

    <div class="mb-3 position-relative">
  <label for="quickFind" class="form-label">Quick Find</label>
  <input type="search" id="quickFind" class="form-control"
         placeholder="Type: nappy, wee, poo, sleep, gym, smoothie‚Ä¶"
         autocomplete="off">
  <div id="quickFindResults"
       class="list-group position-absolute w-100 shadow"
       style="z-index:1000; max-height: 280px; overflow:auto; display:none"></div>
  </div>

  <!-- Quick Pick Buttons -->
  {% if quick_picks %}
  <div class="mb-3">
    <label class="form-label">Quick Pick:</label>
    <div class="d-flex flex-wrap gap-2">
      {% for qp in quick_picks %}
        <button type="button" class="btn btn-outline-primary btn-sm quick-pick-btn" 
                data-activity="{{ qp.activity.name }}"
                {% if qp.activity_value_id %}
                  data-value="{{ qp.activity_value.value }}"
                  data-value-type="{{ qp.activity_value.label }}"
                {% elif qp.value and qp.value_type %}
                  data-value="{{ qp.value }}"
                  data-value-type="{{ qp.value_type }}"
                {% else %}
                  {# No value - just select activity #}
                {% endif %}>
          {{ qp.button_text }}
        </button>
      {% endfor %}
    </div>
  </div>
  {% endif %}


    <form id="logForm" method="post" enctype="multipart/form-data">
        <label for="activity_name">Activity:</label>
        <select name="activity_name" id="activity_name" required>
            <option value="">Select an Activity</option>
            {% if activities %}
                {% for activity in activities %}
                    <option value="{{ activity.name }}">{{ activity.name }}</option>
                {% endfor %}
            {% else %}
                {# Fallback to hardcoded if database not migrated yet #}
                <option value="Mood">Mood</option>
                <option value="Sleep Quality">Sleep Quality</option>
                <option value="Nap Taken">Nap Taken</option>
                <option value="Toilet Tries">Toilet Tries</option>
                <option value="Accidents">Accidents</option>
                <option value="Bath/Shower Completed">Bath/Shower Completed</option>
                <option value="Teeth Brushed">Teeth Brushed</option>
                <option value="Walking Ability">Walking Ability</option>
                <option value="Motor Skills">Motor Skills</option>
                <option value="Communication Level">Communication Level</option>
                <option value="Fluid Intake">Fluid Intake</option>
                <option value="Meltdowns">Meltdowns</option>
                <option value="Sensory Sensitivities">Sensory Sensitivities</option>
                <option value="Exercise / Physical Activity">Exercise / Physical Activity</option>
                <option value="Menstrual Cycle">Menstrual Cycle</option>
                <option value="Food">Food</option>
                <option value="Message for Careers">Message for Careers</option>
                <option value="Health / Medical">Health / Medical</option>
            {% endif %}
        </select>

        <label for="value-select">Value:</label>
        <div id="value-container">
            <select name="value" id="value-select" style="display: none;"></select>
            <input type="text" name="value" id="value-text">
            <input type="hidden" name="calculated_value" id="calculated_value">
        </div>

        <label for="notes">Notes (optional):</label>
        <textarea name="notes" id="notes"></textarea>

        <div class="mt-3 p-3 border rounded" id="relatedFocusSection" style="display: none;">
          <label class="form-label"><strong>Related Focus - Will be automatically recorded</strong></label>
          <div class="border rounded p-3 bg-light" style="max-height: 200px; overflow-y: auto;" id="autoCaptureTasks">
            <p class="text-muted small mb-0">No matching focused tasks for this activity.</p>
          </div>
          <input type="hidden" name="focus_task_id" id="auto_focus_task_id" value="">
          <input type="hidden" name="focus_as_check" id="auto_focus_as_check" value="on">
        </div>

        <!-- AAC / GAS extras (shown only for Communication Level) -->
        <div id="aacExtras" style="display:none; margin-top:12px; padding:10px; border:1px dashed #ccc; border-radius:6px;">
          <div class="mb-2">
            <label class="form-label">GAS & AAC Prompting level</label>
            <select name="aac_prompting_level" class="form-select">
              <option value="">‚Äî</option>
              <option>Independent</option>
              <option>Expectant/thoughtful pause</option>
              <option>Facial expression</option>
              <option>Body language</option>
              <option>Observation/comment</option>
              <option>Visual prompt/gestural cue</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">iPad use</label>
            <select name="ipad_use" class="form-select">
              <option value="">‚Äî</option>
              <option value="Yes">Yes</option>
              <option value="No">No</option>
            </select>
          </div>

          <div class="mb-2">
            <label class="form-label">Words used (if any)</label>
            <input name="aac_words_used" class="form-control" placeholder="yes, no, stop, go‚Ä¶">
          </div>

          <!-- Keep this whole block inside #aacExtras -->
          <input type="hidden" name="aac_goal_no" id="aac_goal_no" value="1">

          <div class="mb-2">
            <label class="form-label">Attainment (pick goal + level)</label>
            <select name="aac_attainment_level" id="attainment_picker" class="form-select" required>

              <optgroup label="Goal 1 ‚Äî Linguistic/Social: Requests single words">
                <option value="2" data-goal="1" data-desc="+2 Much greater than expected ‚Äî Tamara will use single words on their device to ask for a desired item, independently, by the end of a 4-week trial.">
                  Goal 1 ‚Ä¢ +2 ‚Äî Much greater than expected
                </option>
                <option value="1" data-goal="1" data-desc="+1 Greater than expected ‚Äî Tamara will use single words on their device to ask for desired items when provided with an expectant/thoughtful pause, by the end of a 4-week trial.">
                  Goal 1 ‚Ä¢ +1 ‚Äî Greater than expected
                </option>
                <option value="0" data-goal="1" data-desc="0 Expected ‚Äî Tamara will use single words on their device to ask for desired items when their communication partner makes a comment as a prompt (e.g. ‚Äúit looks like you want something‚Äù), by the end of a 4-week trial.">
                  Goal 1 ‚Ä¢ 0 ‚Äî Expected
                </option>
                <option value="-1" data-goal="1" data-desc="-1 Less than expected ‚Äî Tamara will use single words on their device to ask for desired items when provided with a gestural cue (e.g. tapping on device), by the end of a 4-week trial.">
                  Goal 1 ‚Ä¢ -1 ‚Äî Less than expected
                </option>
                <option value="-2" data-goal="1" data-desc="-2 Baseline ‚Äî Tamara currently looks at the item she wants and the communication partner most of the time.">
                  Goal 1 ‚Ä¢ -2 ‚Äî Baseline
                </option>
              </optgroup>

              <optgroup label="Goal 2 ‚Äî Operational: 2-hit selection + navigate back">
                <option value="2" data-goal="2" data-desc="+2 Much greater than expected ‚Äî Tamara will make a 2-hit selection to select a word and navigate back to home (back/core button) when given a visual prompt, by the end of a 4-week trial.">
                  Goal 2 ‚Ä¢ +2 ‚Äî Much greater than expected
                </option>
                <option value="1" data-goal="2" data-desc="+1 Greater than expected ‚Äî Tamara will touch two buttons (make a 2-hit selection) to select a word, independently, by the end of a 4-week trial.">
                  Goal 2 ‚Ä¢ +1 ‚Äî Greater than expected
                </option>
                <option value="0" data-goal="2" data-desc="0 Expected ‚Äî Tamara will touch two buttons (make a 2-hit selection by navigating through a folder) to select a word when given a visual prompt (e.g. pointing), by the end of a 4-week trial.">
                  Goal 2 ‚Ä¢ 0 ‚Äî Expected
                </option>
                <option value="-1" data-goal="2" data-desc="-1 Less than expected ‚Äî Tamara will consistently touch a button on the screen once (make a 1-hit selection) to select a word when given a visual/verbal prompt, by the end of a 4-week trial.">
                  Goal 2 ‚Ä¢ -1 ‚Äî Less than expected
                </option>
                <option value="-2" data-goal="2" data-desc="-2 Baseline ‚Äî Tamara sometimes (inconsistently) attempts to touch the AAC system when prompted.">
                  Goal 2 ‚Ä¢ -2 ‚Äî Baseline
                </option>
              </optgroup>

              <optgroup label="Goal 3 ‚Äî Strategic/Social: Gain partner‚Äôs attention with AAC">
                <option value="2" data-goal="3" data-desc="+2 Much greater than expected ‚Äî Tamara will gain partner‚Äôs attention by picking up the AAC device and bringing it to partner (may also vocalise or touch).">
                  Goal 3 ‚Ä¢ +2 ‚Äî Much greater than expected
                </option>
                <option value="1" data-goal="3" data-desc="+1 Greater than expected ‚Äî Tamara will gain partner‚Äôs attention by expressing symbols on the AAC device and looking at communication partner.">
                  Goal 3 ‚Ä¢ +1 ‚Äî Greater than expected
                </option>
                <option value="0" data-goal="3" data-desc="0 Expected ‚Äî Tamara will gain partner‚Äôs attention by reaching out to the AAC device and looking at communication partner.">
                  Goal 3 ‚Ä¢ 0 ‚Äî Expected
                </option>
                <option value="-1" data-goal="3" data-desc="-1 Less than expected ‚Äî Tamara will gain partner‚Äôs attention by coming up to communication partner and looking/touching/vocalising/gesturing.">
                  Goal 3 ‚Ä¢ -1 ‚Äî Less than expected
                </option>
                <option value="-2" data-goal="3" data-desc="-2 Baseline ‚Äî Tamara will gain partner‚Äôs attention by looking at them and/or looking at the item she wants.">
                  Goal 3 ‚Ä¢ -2 ‚Äî Baseline
                </option>
              </optgroup>

            </select>
            <div id="attainment_help" class="muted" style="margin-top:6px;" aria-live="polite">
              +2 Much greater than expected ‚Äî Tamara will use single words on their device to ask for a desired item, independently, by the end of a 4-week trial.
            </div>
          </div>


          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="also_create_aac" name="also_create_aac" checked>
            <label class="form-check-label" for="also_create_aac">
              Also save to GAS & AAC tracker
            </label>
          </div>

          <div class="form-check mt-1">
            <input class="form-check-input" type="checkbox" id="also_make_prompt_log" name="also_make_prompt_log" checked>
            <label class="form-check-label" for="also_make_prompt_log">
              Also add ‚ÄúGAS & AAC Prompting Level‚Äù entry to classic logs
            </label>
          </div>
        </div>

        <script>
        (function(){
          const activitySel = document.getElementById('activity_name');
          const aacExtras   = document.getElementById('aacExtras');
          const picker      = document.getElementById('attainment_picker');
          const help        = document.getElementById('attainment_help');
          const goalHidden  = document.getElementById('aac_goal_no');

          function syncAttainmentHelpAndGoal(){
            if (!picker) return;
            const opt = picker.options[picker.selectedIndex];
            if (!opt) return;
            help.textContent   = opt.getAttribute('data-desc') || '';
            goalHidden.value   = opt.getAttribute('data-goal') || '1';
          }

          function toggleAAC(){
            const isComm = (activitySel.value === 'Communication Level');
            aacExtras.style.display = isComm ? 'block' : 'none';

            // Only require the picker when Communication Level is chosen
            if (picker) picker.required = isComm;

            // Keep goal + helper text in sync if visible
            if (isComm) syncAttainmentHelpAndGoal();
          }

          if (picker) picker.addEventListener('change', syncAttainmentHelpAndGoal);
          activitySel.addEventListener('change', toggleAAC);

          // run once on load
          toggleAAC();
          if (picker) syncAttainmentHelpAndGoal();
        })();
        </script>

        <!-- Confirmation modal for Sleep/Nap -->
        <div id="sleepNapModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 10px; max-width: 400px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                <p id="modalMessage" style="font-size: 16px; margin-bottom: 20px; line-height: 1.5;"></p>
                <div style="display: flex; gap: 15px; justify-content: center;">
                    <button type="button" id="modalYes" style="padding: 10px 30px; font-size: 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Yes</button>
                    <button type="button" id="modalNo" style="padding: 10px 30px; font-size: 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">No</button>
                </div>
            </div>
        </div>

        <!-- Quick AAC Reminder Modal (shows after login) -->
        <div id="aacReminderModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10001; align-items: center; justify-content: center;">
            <div style="background: white; padding: 40px; border-radius: 15px; max-width: 500px; text-align: center; box-shadow: 0 8px 16px rgba(0,0,0,0.4);">
                <h3 style="color: #0dcaf0; margin-bottom: 20px; font-weight: bold;">üì± Quick AAC Check - Focused Task</h3>
                <p style="font-size: 18px; margin-bottom: 15px; line-height: 1.6; color: #333;">
                    <strong>Important:</strong> Remember to log communication events using the Quick AAC Check page.
                </p>
                <p style="font-size: 16px; margin-bottom: 25px; line-height: 1.5; color: #666;">
                    This is a critical Focused Task. Log AAC access rating + focus words modelled every shift (takes 10 seconds).
                </p>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                    <button type="button" id="aacModalGo" style="padding: 12px 30px; font-size: 18px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Go to Quick AAC Check</button>
                    <button type="button" id="aacModalLater" style="padding: 12px 30px; font-size: 16px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">I'll do it later</button>
                </div>
            </div>
        </div>

        <script>
        // Confirmation modal with Yes/No buttons - FIXED with type="button" to prevent form submission
        function customConfirm(message, yesCallback, noCallback) {
            const modal = document.getElementById('sleepNapModal');
            const messageEl = document.getElementById('modalMessage');
            const yesBtn = document.getElementById('modalYes');
            const noBtn = document.getElementById('modalNo');
            
            if (!modal || !messageEl || !yesBtn || !noBtn) {
                const result = confirm(message);
                if (result && yesCallback) yesCallback();
                if (!result && noCallback) noCallback();
                return;
            }
            
            messageEl.textContent = message;
            modal.style.display = 'flex';
            
            // Clone buttons to remove old listeners
            const newYesBtn = yesBtn.cloneNode(true);
            const newNoBtn = noBtn.cloneNode(true);
            yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);
            noBtn.parentNode.replaceChild(newNoBtn, noBtn);
            
            newYesBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                modal.style.display = 'none';
                if (yesCallback) yesCallback();
            });
            
            newNoBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                modal.style.display = 'none';
                if (noCallback) noCallback();
            });
        }
        
        // Helper function to continue setup after activity is confirmed set
        function continueSetup(activityName) {
            const activitySelect = document.getElementById("activity_name");
            if (!activitySelect) return;
            
            // Show correct duration dropdown
            showCorrectDurationDropdown(activityName);
            
            // Initialize value select with explicit activity name (not reading from select)
            initializeValueSelect(activityName);
            
            // Rebind listeners
            valueSelect.addEventListener("change", syncMultiFields);
            syncMultiFields();
            
            // Clone to remove old listeners
            const newValueSelect = valueSelect.cloneNode(true);
            valueSelect.parentNode.replaceChild(newValueSelect, valueSelect);
            valueSelect = newValueSelect;
            
            // Re-add change listener
            valueSelect.addEventListener("change", function () {
                const selectedOptions = Array.from(valueSelect.selectedOptions);
                const labels = selectedOptions.map(opt => opt.textContent);
                valueTypeInput.value = labels.join(", ");
                if (activitySelect.value === "Exercise / Physical Activity") {
                    const values = selectedOptions.map(opt => parseFloat(opt.value)).filter(v => !isNaN(v));
                    const mean = values.length > 0 ? (values.reduce((sum, val) => sum + val, 0) / values.length).toFixed(2) : "";
                    calculatedValueInput.value = mean;
                    valueText.value = mean;
                } else if (activitySelect.value === "Food") {
                    const count = selectedOptions.length;
                    calculatedValueInput.value = count > 0 ? count : "";
                    valueText.value = count > 0 ? count : "";
                } else {
                    calculatedValueInput.value = "";
                    valueText.value = selectedOptions.map(opt => opt.value).join(",");
                }
            });
        }
        
        // Helper function to set up activity properly
        function setupActivityForSleepNap(activityName) {
            const activitySelect = document.getElementById("activity_name");
            if (!activitySelect) return;
            
            // Explicitly set the activity value FIRST
            activitySelect.value = activityName;
            
            // Activity set, continue with setup immediately (no verification delays)
            continueSetup(activityName);
        }

        // Initialize duration dropdown visibility on page load
        document.addEventListener('DOMContentLoaded', function() {
            const activitySelect = document.getElementById("activity_name");
            const durationDefault = document.getElementById("duration");
            const durationSleep = document.getElementById("duration_sleep");
            const durationNap = document.getElementById("duration_nap");
            
            // Set initial state - default duration visible, others hidden
            if (durationDefault) {
                durationDefault.style.display = "block";
                durationDefault.name = "duration";
                durationDefault.required = true;
            }
            if (durationSleep) {
                durationSleep.style.display = "none";
                durationSleep.name = "temp";
                durationSleep.required = false;
            }
            if (durationNap) {
                durationNap.style.display = "none";
                durationNap.name = "temp";
                durationNap.required = false;
            }
        });
        </script>

        <label for="activity_datetime">Time of Activity:</label>
        <input type="datetime-local" name="activity_datetime" id="activity_datetime"
               value="{{ current_datetime }}" required>

        <label for="duration">Duration:</label>
        <!-- Default duration dropdown (for most activities) -->
        <select name="duration" id="duration" required>
            <option value="5">5 minutes</option>
            <option value="15">15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">1 hour</option>
            <option value="120">2 hours</option>
            <option value="150">2.5 hours</option>
            <option value="180">3 hours</option>
            <option value="210">3.5 hours</option>
            <option value="240">4 hours</option>
            <option value="270">4.5 hours</option>
            <option value="300">5 hours</option>
            <option value="240">Half Day</option>
            <option value="480">Full Day</option>
            <option value="180">All Morning</option>
            <option value="180">All Afternoon</option>
            <option value="480">All Night</option>
            <option value="720">All Day</option>
        </select>
        <!-- Sleep duration dropdown (longer durations) -->
        <select name="duration" id="duration_sleep" required style="display: none;">
            <option value="420">7 hours</option>
            <option value="480">8 hours</option>
            <option value="540">9 hours</option>
            <option value="600">10 hours</option>
            <option value="660">11 hours</option>
            <option value="720">12 hours</option>
            <option value="480" selected>All Night</option>
        </select>
        <!-- Nap duration dropdown (shorter durations) -->
        <select name="duration" id="duration_nap" required style="display: none;">
            <option value="5">5 minutes</option>
            <option value="15">15 minutes</option>
            <option value="30">30 minutes</option>
            <option value="60">1 hour</option>
            <option value="90">1.5 hours</option>
            <option value="120">2 hours</option>
            <option value="150">2.5 hours</option>
            <option value="180">3 hours</option>
        </select>

        <label>Upload Media (optional):</label>
        <input type="file" name="media" id="media" accept="image/*,video/*,.heic" multiple>
        <button type="button" id="addMoreBtn" class="btn btn-secondary btn-add-more">Add More Media</button>
        <div class="media-preview" id="media-preview"></div>

        <input type="hidden" name="value_type" id="value_type">

        <input type="submit" value="Log Entry" class="btn btn-primary">
    </form>

    <script>
// Activity values loaded from database
const activityValues = {
  {% if activities %}
    {% for activity in activities %}
      "{{ activity.name|e }}": [
        {% for value in activity.values|sort(attribute='display_order') %}
          {
            label: {{ value.label|tojson }},
            value: {{ value.value|tojson }}{% if value.description %},
            description: {{ value.description|tojson }}{% endif %}
          }{% if not loop.last %},{% endif %}
        {% endfor %}
      ]{% if not loop.last %},{% endif %}
    {% endfor %}
  {% else %}
    {# Fallback to hardcoded if database not migrated yet #}
    "Mood": [
    { label: "Upset", value: "1" },
    { label: "Low", value: "2" },
    { label: "Okay", value: "3" },
    { label: "Cheerful", value: "4" },
    { label: "Elated", value: "5" }
  ],
  "Sleep Quality": [
    { label: "7-8 hours", value: "1" },
    { label: "8-9 hours", value: "2" },
    { label: "9-10 hours", value: "3" },
    { label: "10+ hours", value: "4" }
  ],
  "Nap Taken": [
    { label: "Yes", value: "1" },
    { label: "No", value: "0" }
  ],
  "Toilet Tries": [
    { label: "Yes Both", value: "4" },
    { label: "Yes Poo", value: "3" },
    { label: "Yes Wee", value: "2" },
    { label: "Tried No Success", value: "1" }
  ],
  "Accidents": [
    { label: "Wet", value: "1" },
    { label: "Soiled", value: "2" },
    { label: "Both", value: "3" }
  ],
  "Bath/Shower Completed": [
    { label: "Yes", value: "1" },
    { label: "No", value: "0" }
  ],
  "Teeth Brushed": [
    { label: "Yes", value: "1" },
    { label: "No", value: "0" }
  ],
  "Walking Ability": [
    { label: "Needs Help", value: "1" },
    { label: "Independent", value: "2" }
  ],
  "Motor Skills": [
    { label: "Poor", value: "1" },
    { label: "Fair", value: "2" },
    { label: "Good", value: "3" }
  ],
  "Communication Level": [
    { label: "No communication No observable communication or response", value: "1", description: "No observable communication or response" },
    { label: "Passive communication Not initiating communication; prompt dependent", value: "2", description: "Not initiating communication; prompt dependent" },
    { label: "Minimal communication, not directed at others Body language / eye gaze / vocalisations not directed at others", value: "3", description: "Body language / eye gaze / vocalisations not directed at others" },
    { label: "Directed communication without back-and-forth Gestures, expressions or vocalisations directed at others, but limited exchange", value: "4", description: "Gestures, expressions or vocalisations directed at others, but limited exchange" },
    { label: "Back and forth communication Engages in two-way interaction using multiple communication methods", value: "5", description: "Engages in two-way interaction using multiple communication methods" }
  ],
  "Fluid Intake": [
    { label: "50ml", value: "1" },
    { label: "100ml", value: "2" },
    { label: "200ml", value: "3" },
    { label: "300ml", value: "4" },
    { label: "500ml+", value: "5" }
  ],
  "Meltdowns": [
    { label: "None", value: "0" },
    { label: "Mild", value: "1" },
    { label: "Moderate", value: "2" },
    { label: "Severe", value: "3" }
  ],
  "Sensory Sensitivities": [
    { label: "Sound", value: "1" },
    { label: "Light", value: "2" },
    { label: "Touch", value: "3" },
    { label: "Movement", value: "4" }
  ],
  "Exercise / Physical Activity": [
    { label: "Yoga (Low Intensity)", value: "1.5" },
    { label: "Walking (Light)", value: "2.0" },
    { label: "Park Play (Light-Moderate)", value: "2.5" },
    { label: "Riding Bike (Moderate)", value: "3.5" },
    { label: "Dancing (Moderate-High)", value: "4.2" },
    { label: "Swimming (Moderate-High)", value: "4.0" },
    { label: "Gym Workout (Park Equipment)", value: "4.5" },
    { label: "Trampolining (High Intensity)", value: "5.0" }
  ],
  "Menstrual Cycle": [
    { label: "Spotting", value: "1" },
    { label: "Medium", value: "2" },
    { label: "Heavy", value: "3" }
  ],
  "Food": [
    { label: "Protein", value: "1" },
    { label: "Vegetables", value: "1" },
    { label: "Carbohydrate", value: "1" },
    { label: "Fruit", value: "1" },
    { label: "Cereals", value: "1" },
    { label: "Other", value: "1" }
  ],
  "Message for Careers": [
    { label: "Message", value: "1" }
  ],
  "Health / Medical": [
    { label: "Medication Taken", value: "1" },
    { label: "Doctor's Appointment", value: "1" },
    { label: "Hospital Visit", value: "1" },
    { label: "Large Bloating", value: "1" },
    { label: "Less Bloated", value: "1" },
    { label: "Raynauds Purple Hands or Feet", value: "1" },
    { label: "Raynauds Red Hands or Feet", value: "1" },
    { label: "Dribbling allot", value: "1" },
    { label: "Dribbling Moderate", value: "1" },
    { label: "Dribbling less", value: "1" },
    { label: "Posture - Good/Upright", value: "1" },
    { label: "Posture - Supported/Neutral", value: "1" },
    { label: "Posture - Leaning/Needs Support", value: "1" },
    { label: "Posture - Collapsed", value: "1" },
    { label: "Other", value: "1" }
  ]
  {% endif %}
};

const activitySelect = document.getElementById("activity_name");
let valueSelect = document.getElementById("value-select");
const valueText = document.getElementById("value-text");
const valueTypeInput = document.getElementById("value_type");
const calculatedValueInput = document.getElementById("calculated_value");
const mediaInput = document.getElementById("media");
const mediaPreview = document.getElementById("media-preview");
const addMoreBtn = document.getElementById("addMoreBtn");
const logForm = document.getElementById("logForm");

let selectedFiles = []; // Clear on page load to prevent accumulation

// ‚úÖ helper to sync hidden fields
function syncMultiFields() {
  const selectedOptions = Array.from(valueSelect.selectedOptions || []);
  const labels = selectedOptions.map(opt => opt.textContent);
  valueTypeInput.value = labels.join(", ");

  if (activitySelect.value === "Exercise / Physical Activity") {
    const values = selectedOptions.map(opt => parseFloat(opt.value)).filter(v => !isNaN(v));
    const mean = values.length > 0 ? (values.reduce((s, v) => s + v, 0) / values.length).toFixed(2) : "";
    calculatedValueInput.value = mean;
    valueText.value = mean;
  } else if (activitySelect.value === "Food") {
    const count = selectedOptions.length;
    calculatedValueInput.value = count > 0 ? count : "";
    valueText.value = count > 0 ? count : "";
  } else {
    calculatedValueInput.value = "";
    valueText.value = selectedOptions.map(opt => opt.value).join(",");
  }
}


function initializeValueSelect(activityNameOverride) {
    // Use override if provided, otherwise read from select (backward compatible)
    const selected = activityNameOverride || activitySelect.value;
    
    // Guard: if no activity selected and no override, don't proceed
    if (!selected || selected === "") {
        // Silently return - this prevents errors during race conditions
        return;
    }
    
    const options = activityValues[selected];

    valueSelect.innerHTML = "";
    valueSelect.removeAttribute("multiple");

    if (options) {
        if (selected === "Exercise / Physical Activity" || selected === "Food") {
            valueSelect.setAttribute("multiple", "multiple");
        }

        options.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item.value;
            opt.textContent = item.label;
            valueSelect.appendChild(opt);
        });

        valueSelect.style.display = "block";
        valueSelect.name = "value";
        valueSelect.required = true;
        valueSelect.disabled = false;

        valueText.style.display = "none";
        valueText.name = "temp";
        valueText.required = false;
        valueText.disabled = true;

        const selectedOptions = Array.from(valueSelect.selectedOptions);
        const labels = selectedOptions.map(opt => opt.textContent);
        valueTypeInput.value = labels.join(", ");

        if (selected === "Exercise / Physical Activity") {
            const values = selectedOptions.map(opt => parseFloat(opt.value)).filter(v => !isNaN(v));
            const mean = values.length > 0 ? (values.reduce((sum, val) => sum + val, 0) / values.length).toFixed(2) : "";
            calculatedValueInput.value = mean;
            valueText.value = mean;
        } else if (selected === "Food") {
            const count = selectedOptions.length;
            calculatedValueInput.value = count > 0 ? count : "";
            valueText.value = count > 0 ? count : "";
        } else {
            calculatedValueInput.value = "";
            valueText.value = selectedOptions.map(opt => opt.value).join(",");
        }
    } else {
        valueSelect.style.display = "none";
        valueSelect.name = "temp";
        valueSelect.required = false;
        valueSelect.disabled = true;

        valueText.style.display = "block";
        valueText.name = "value";
        valueText.required = true;
        valueText.disabled = false;

        valueTypeInput.value = "text";
        calculatedValueInput.value = "";
        valueText.value = "";
    }
}

// Helper function to show correct duration dropdown
function showCorrectDurationDropdown(activity) {
    const durationDefault = document.getElementById("duration");
    const durationSleep = document.getElementById("duration_sleep");
    const durationNap = document.getElementById("duration_nap");
    
    // Hide all duration dropdowns first
    if (durationDefault) durationDefault.style.display = "none";
    if (durationSleep) durationSleep.style.display = "none";
    if (durationNap) durationNap.style.display = "none";
    
    // Show the appropriate one
    if (activity === "Sleep Quality") {
        if (durationSleep) {
            durationSleep.style.display = "block";
            durationSleep.required = true;
            durationSleep.name = "duration";
        }
        if (durationDefault) {
            durationDefault.name = "temp";
            durationDefault.required = false;
        }
        if (durationNap) {
            durationNap.name = "temp";
            durationNap.required = false;
        }
    } else if (activity === "Nap Taken") {
        if (durationNap) {
            durationNap.style.display = "block";
            durationNap.required = true;
            durationNap.name = "duration";
        }
        if (durationDefault) {
            durationDefault.name = "temp";
            durationDefault.required = false;
        }
        if (durationSleep) {
            durationSleep.name = "temp";
            durationSleep.required = false;
        }
    } else {
        // Default duration for all other activities
        if (durationDefault) {
            durationDefault.style.display = "block";
            durationDefault.required = true;
            durationDefault.name = "duration";
        }
        if (durationSleep) {
            durationSleep.name = "temp";
            durationSleep.required = false;
        }
        if (durationNap) {
            durationNap.name = "temp";
            durationNap.required = false;
        }
    }
}

// Global flag to prevent modal from showing again when processing after Yes
let processingAfterYes = false;

activitySelect.addEventListener("change", function () {
    const selectedActivity = activitySelect.value;
    
    // If we're processing after Yes was clicked, skip modal and go straight to normal processing
    if (processingAfterYes) {
        processingAfterYes = false;
        // Continue with normal processing below
    } else if (selectedActivity === "Nap Taken") {
        customConfirm(
            "Is this really a nap?\n\nClick YES to continue with 'Nap Taken'.\nClick NO to go back to 'Select an Activity'.",
            function() {
                // Yes - set flag and trigger normal processing
                processingAfterYes = true;
                activitySelect.dispatchEvent(new Event('change'));
            },
            function() {
                // No - reset to empty
                activitySelect.value = "";
            }
        );
        return; // Stop here, normal code will run after Yes via dispatchEvent
    } else if (selectedActivity === "Sleep Quality") {
        customConfirm(
            "Is this really sleep (waking up from night sleep)?\n\nClick YES to continue with 'Sleep Quality'.\nClick NO to go back to 'Select an Activity'.",
            function() {
                // Yes - set flag and trigger normal processing
                processingAfterYes = true;
                activitySelect.dispatchEvent(new Event('change'));
            },
            function() {
                // No - reset to empty
                activitySelect.value = "";
            }
        );
        return; // Stop here, normal code will run after Yes via dispatchEvent
    } else if (selectedActivity === "Communication Level") {
        customConfirm(
            "Are you using the Quick AAC Check page?\n\nClick YES to go to the Quick AAC Check page (faster logging).\nClick NO to continue with the normal log entry form.",
            function() {
                // Yes - redirect to Quick AAC page
                window.location.href = "/quick/aac";
            },
            function() {
                // No - continue with normal processing
                processingAfterYes = true;
                activitySelect.dispatchEvent(new Event('change'));
            }
        );
        return; // Stop here, normal code will run after No via dispatchEvent
    }
    
    // Normal processing for all activities (including Sleep/Nap after Yes is clicked)
    showCorrectDurationDropdown(selectedActivity);
    initializeValueSelect(selectedActivity);
    
    // ensure listener + initial sync on page load
    valueSelect.addEventListener("change", syncMultiFields);
    syncMultiFields();
});

initializeValueSelect();

mediaInput.addEventListener("change", async function (e) {
    const newFiles = Array.from(e.target.files);
    let totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
    const maxSize = 50 * 1024 * 1024; // 50MB to match server limit

    for (const file of newFiles) {
        if (file.size > maxSize) {
            alert(`File "${file.name}" exceeds 50MB. Please select a smaller file.`);
            continue;
        }
        if (totalSize + file.size > maxSize) {
            alert(`Total upload size exceeds 50MB. Please remove some files or select smaller ones.`);
            continue;
        }
        if (file.type.startsWith("image/") || file.name.toLowerCase().endsWith(".heic")) {
            console.log(`Resizing image: ${file.name}`);
            const resizedBlob = await resizeImage(file, 1024);
            selectedFiles.push(new File([resizedBlob], file.name, { type: "image/jpeg" }));
        } else {
            console.log(`Adding non-image file: ${file.name}`);
            selectedFiles.push(file); // Videos are not resized
        }
        totalSize += selectedFiles[selectedFiles.length - 1].size;
    }
    updatePreviews();
    mediaInput.value = '';
});

function updatePreviews() {
    mediaPreview.innerHTML = '';
    selectedFiles.forEach((file, index) => {
        const preview = document.createElement("div");
        preview.className = "media-item";
        const removeBtn = document.createElement("button");
        removeBtn.className = "remove-btn";
        removeBtn.textContent = "√ó";
        removeBtn.title = "Remove";
        removeBtn.onclick = () => {
            selectedFiles.splice(index, 1);
            updatePreviews();
        };

        if (file.type.startsWith("image/") || file.name.toLowerCase().endsWith(".heic")) {
            const img = document.createElement("img");
            img.src = URL.createObjectURL(file);
            preview.appendChild(img);
        } else if (file.type.startsWith("video/")) {
            const video = document.createElement("video");
            video.controls = true;
            const source = document.createElement("source");
            source.src = URL.createObjectURL(file);
            source.type = file.type;
            video.appendChild(source);
            preview.appendChild(video);
        }
        preview.appendChild(removeBtn);
        mediaPreview.appendChild(preview);
    });
}

// Resize image to maxWidth (keeps aspect ratio)
function resizeImage(file, maxWidth) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = function (event) {
            const img = new Image();
            img.onload = function () {
                const canvas = document.createElement("canvas");
                const scale = maxWidth / img.width;
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, "image/jpeg", 0.7); // 70% quality
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });
}

addMoreBtn.addEventListener("click", function () {
    mediaInput.click();
});

logForm.addEventListener("submit", function (e) {
  e.preventDefault();
  syncMultiFields(); // final sync before submit

  const formData = new FormData(logForm);
  selectedFiles.forEach(file => {
    formData.append('media', file);
  });

  for (let [key, value] of formData.entries()) {
    console.log(`FormData: ${key} = ${value}`);
  }

  fetch('/log', {
    method: 'POST',
    body: formData
  }).then(response => {
    if (!response.ok) {
      if (response.status === 413) {
        throw new Error('Upload size exceeds 50MB. Please remove some files and try again.');
      }
      throw new Error(`HTTP error! Status: ${response.status}`);
    }
    window.location.href = response.url || '/log';
  }).catch(error => {
    console.error('Log Submission Error:', error);
    alert('Error logging entry: ' + error.message);
  });
});



    </script>

    <script>
// ---------- Hidden synonym tags (activities) ----------
const activitySynonyms = {
  "Toilet Tries": ["toilet","toileting","wc","loo","bathroom","pee","wee","urine","poo","poop","bowel","bm","number two","constipated","void"],
  "Accidents": ["accident","nappy","diaper","pull-up","pull up","wet","soiled","leak","leaking","urine","bm","stool","dirty"],
  "Menstrual Cycle": ["period","menstruation","spotting","pads","bleeding","change"],
  "Sleep Quality": ["sleep","slept","sleepy","tired","dozing","awake","woke"],
  "Nap Taken": ["nap","snooze","doze","asleep","car nap"],
  "Mood": ["mood","happy","smiley","cheerful","low","flat","upset","sad","elated","okay","ok","smiling","grumpy"],
  "Food": ["food","eat","ate","lunch","breakfast","dinner","meal","snack","smoothie","sandwich","soup","porridge","toasted","cereal"],
  "Exercise / Physical Activity": ["exercise","gym","walk","trampoline","trampolining","bike","ride","dance","park","play","swim","yoga","swing"],
  "Health / Medical": ["doctor","gp","medical","medication","hospital","bloating","raynauds","dribbling","clinic","appointment"],
  "Message for Careers": ["message","note","update","comment","info","heads up"],
  "Fluid Intake": ["water","drink","ml","hydration","fluids","sip","sips","bottle","cups"],
  "Sensory Sensitivities": ["sound","noise","light","touch","movement","sensory","overstimulated","sensitive"],
  "Motor Skills": ["motor","fine motor","gross motor","hands","buttons","pencil","cutlery","dexterity","walking","posture","balance","standing","movement"],
  "Walking Ability": ["walking","gait","mobility","independent","needs help"],
  "Bath/Shower Completed": ["bath","shower","hygiene","wash","clean"],
  "Teeth Brushed": ["teeth","brush","dental","oral care"]
};

// ---------- Hidden synonym tags (specific values) ----------
const valueSynonyms = {
  "Toilet Tries::Yes Wee": ["wee","pee","urine","peed"],
  "Toilet Tries::Yes Poo": ["poo","pooped","bm","bowel","stool","number two"],
  "Toilet Tries::Yes Both": ["both","wee and poo","urine and stool"],
  "Toilet Tries::Tried No Success": ["tried","no success","sat on toilet","no wee","no poo"],

  "Accidents::Wet": ["wet","wee","urine","leak"],
  "Accidents::Soiled": ["soiled","poo","bm","stool","feces","faeces"],
  "Accidents::Both": ["both","wet and soiled"],

  "Nap Taken::Yes": ["nap","asleep","slept","dozed"],
  "Nap Taken::No": ["no nap","awake"],

  "Mood::Upset": ["upset","angry","frustrated","teary"],
  "Mood::Low": ["low","flat","sad","down"],
  "Mood::Okay": ["ok","okay","fine","neutral"],
  "Mood::Cheerful": ["happy","smiley","cheerful","smiling"],
  "Mood::Elated": ["elated","excited","euphoric"],

  "Food::Protein": ["meat","fish","chicken","egg","tofu","protein"],
  "Food::Vegetables": ["veg","veggies","vegetables","salad","greens"],
  "Food::Carbohydrate": ["carb","rice","pasta","bread","potato"],
  "Food::Fruit": ["fruit","banana","apple","berries"],
  "Food::Cereals": ["cereal","porridge","muesli"],
  "Food::Other": ["smoothie","soup","snack","sandwich","toast"],

  "Fluid Intake::50ml": ["sip","sips","50ml","small drink"],
  "Fluid Intake::100ml": ["100ml"],
  "Fluid Intake::200ml": ["200ml"],
  "Fluid Intake::300ml": ["300ml"],
  "Fluid Intake::500ml+": ["500ml","bottle","lots of water","well hydrated"]
};

// ---------- Quick Find UI wiring ----------
const quickFind = document.getElementById('quickFind');
const quickFindResults = document.getElementById('quickFindResults');

function norm(s){ return (s||"").toLowerCase().trim(); }

// Build a simple search Candidates list on demand
function searchCandidates(q){
  const query = norm(q);
  if(!query) return [];

  const tokens = query.split(/\s+/);

  const candidates = [];

  // 1) Activity matches
  Object.keys(activityValues).forEach(act => {
    const actName = norm(act);
    let score = 0;

    // direct name hit
    if (actName.includes(query)) score += 4;

    // synonym hits
    (activitySynonyms[act] || []).forEach(tag => {
      if (norm(tag).includes(query)) score += 3;
      // token bonus
      tokens.forEach(t => { if (t && norm(tag).includes(t)) score += 1; });
    });

    // value-level matches
    const opts = activityValues[act];
    if (Array.isArray(opts)){
      // opts could be array of strings or {label,value}
      opts.forEach(opt => {
        const label = typeof opt === 'string' ? opt : (opt.label || opt.value || "");
        const shown = norm(label);
        if (shown.includes(query)) {
          candidates.push({
            type: 'value',
            activity: act,
            valueLabel: label,
            score: score + 5,
            reason: `matches value ‚Äú${label}‚Äù`
          });
        }
        // value synonyms
        const vsKey = `${act}::${label}`;
        (valueSynonyms[vsKey] || []).forEach(tag => {
          if (norm(tag).includes(query)) {
            candidates.push({
              type: 'value',
              activity: act,
              valueLabel: label,
              score: score + 6,
              reason: `matches ‚Äú${tag}‚Äù`
            });
          }
        });
      });
    }

    if (score > 0){
      candidates.push({
        type: 'activity',
        activity: act,
        score,
        reason: 'activity match'
      });
    }
  });

  // sort high score first, then prefer value-level suggestions
  candidates.sort((a,b) => (b.score - a.score) || ((a.type==="value")? -1:1));
  // de-dup by activity+valueLabel
  const seen = new Set();
  const unique = [];
  for (const c of candidates){
    const key = `${c.activity}::${c.valueLabel||""}`;
    if (!seen.has(key)){
      seen.add(key);
      unique.push(c);
    }
    if (unique.length >= 10) break; // top 10
  }
  return unique;
}

function renderResults(items){
  if(!items.length){
    quickFindResults.style.display = 'none';
    quickFindResults.innerHTML = '';
    return;
  }
  quickFindResults.innerHTML = items.map((it, idx) => {
    const title = it.type === 'value'
      ? `${it.activity} ‚Üí ${it.valueLabel}`
      : it.activity;
    return `<button type="button"
                   class="list-group-item list-group-item-action"
                   data-idx="${idx}">
              ${title}
              <small class="text-muted"> ${it.reason}</small>
            </button>`;
  }).join('');
  quickFindResults.style.display = 'block';
}

let lastResults = [];

quickFind.addEventListener('input', (e) => {
  lastResults = searchCandidates(e.target.value);
  renderResults(lastResults);
});

quickFindResults.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-idx]');
  if(!btn) return;
  const pick = lastResults[Number(btn.dataset.idx)];
  applySuggestion(pick);
});

quickFind.addEventListener('keydown', (e) => {
  // Enter = apply top suggestion
  if (e.key === 'Enter' && lastResults.length){
    e.preventDefault();
    applySuggestion(lastResults[0]);
  }
});

function applySuggestion(sug){
  // 1) select activity
  activitySelect.value = sug.activity;
  activitySelect.dispatchEvent(new Event('change')); // will rebuild the value select

  // 2) if value suggestion, try to preselect value
  if (sug.type === 'value' && valueSelect){
    const wanted = norm(sug.valueLabel);
    Array.from(valueSelect.options).forEach(opt => {
      if (norm(opt.textContent) === wanted) opt.selected = true;
    });
    valueSelect.dispatchEvent(new Event('change'));
    valueSelect.scrollIntoView({behavior:'smooth', block:'center'});
    // optional flash
    valueSelect.style.boxShadow = '0 0 0 0.25rem rgba(13,110,253,.25)';
    setTimeout(()=> valueSelect.style.boxShadow = '', 1200);
  } else {
    // just scroll to the value area
    valueSelect.scrollIntoView({behavior:'smooth', block:'center'});
  }

  // hide results
  quickFindResults.style.display = 'none';
}

// ---------- Quick Pick Button Handler ----------
document.querySelectorAll('.quick-pick-btn').forEach(btn => {
  // Add scroll to value section after setting values
  btn.addEventListener('click', function() {
    const activity = this.dataset.activity;
    const value = this.dataset.value;
    const valueType = this.dataset.valueType;
    
    // Set activity
    activitySelect.value = activity;
    activitySelect.dispatchEvent(new Event('change'));
    
    // If no value/valueType provided, just select activity and scroll to value section
    if (!value && !valueType) {
      setTimeout(() => {
        // Scroll to value section so carer can pick
        const valueContainer = document.getElementById('value-container');
        if (valueContainer) {
          valueContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else if (valueSelect) {
          valueSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        // Focus on value select
        if (valueSelect && valueSelect.style.display !== 'none') {
          valueSelect.focus();
        } else if (valueText && valueText.style.display !== 'none') {
          valueText.focus();
        }
        // Visual feedback
        this.style.transform = 'scale(0.95)';
        setTimeout(() => { this.style.transform = ''; }, 150);
      }, 150);
      return; // Exit early - no value to set
    }
    
    // Wait for value select to populate, then set value
    setTimeout(() => {
      // First, try to match by value_type (label) if provided
      if (valueSelect && valueType) {
        let matched = false;
        Array.from(valueSelect.options).forEach(opt => {
          const optLabel = opt.textContent.trim();
          if (optLabel === valueType || optLabel.toLowerCase() === valueType.toLowerCase()) {
            opt.selected = true;
            matched = true;
            if (valueSelect.hasAttribute('multiple')) {
              valueSelect.dispatchEvent(new Event('change'));
            }
          }
        });
        
        // If matched by label, sync fields and return
        if (matched) {
          syncMultiFields();
          if (valueSelect && !valueSelect.hasAttribute('multiple')) {
            valueSelect.dispatchEvent(new Event('change'));
          }
          // Scroll to value section
          const valueContainer = document.getElementById('value-container');
          if (valueContainer) {
            valueContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
          } else if (valueSelect) {
            valueSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          document.getElementById('notes')?.focus();
          this.style.transform = 'scale(0.95)';
          setTimeout(() => { this.style.transform = ''; }, 150);
          return;
        }
      }
      
      // Fallback: match by value
      if (valueSelect && value) {
        Array.from(valueSelect.options).forEach(opt => {
          if (opt.value === value) {
            opt.selected = true;
            if (valueSelect.hasAttribute('multiple')) {
              valueSelect.dispatchEvent(new Event('change'));
            }
          }
        });
        syncMultiFields();
        
        // Set value_type if provided and not already set
        if (valueTypeInput && valueType && !valueTypeInput.value) {
          valueTypeInput.value = valueType;
        }
      }
      
      // Scroll to value section
      const valueContainer = document.getElementById('value-container');
      if (valueContainer) {
        valueContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else if (valueSelect) {
        valueSelect.scrollIntoView({ behavior: 'smooth', block: 'center' });
      } else if (valueText) {
        valueText.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
      
      // Focus notes field for quick entry
      const notesField = document.getElementById('notes');
      if (notesField) {
        notesField.focus();
      }
      
      // Visual feedback
      this.style.transform = 'scale(0.95)';
      setTimeout(() => {
        this.style.transform = '';
      }, 150);
    }, 150);
  });
});
</script>

<script>
(function () {
  const picker = document.getElementById('attainment_picker');
  const help = document.getElementById('attainment_help');

  function syncFromSelection() {
    const opt = picker.options[picker.selectedIndex];
    if (!opt) return;
    const desc = opt.getAttribute('data-desc') || '';
    help.textContent = desc;
  }

  picker.addEventListener('change', syncFromSelection);
  syncFromSelection();
})();
</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // Show Quick AAC Reminder Modal after login
    // This works with the noticeboard modal - if noticeboard shows, this will show after it closes
    {% if session.get('just_logged_in') %}
    document.addEventListener('DOMContentLoaded', function() {
        const modal = document.getElementById('aacReminderModal');
        const goBtn = document.getElementById('aacModalGo');
        const laterBtn = document.getElementById('aacModalLater');
        const noticeBoardModal = document.getElementById('noticeBoardModal');
        
        if (!modal || !goBtn || !laterBtn) return;
        
        const showAACModal = function() {
            modal.style.display = 'flex';
            
            goBtn.onclick = function() {
                window.location.href = '/quick/aac';
            };
            
            laterBtn.onclick = function() {
                modal.style.display = 'none';
                // Clear the flag so it doesn't show again this session
                fetch('/clear-login-flag', { method: 'POST' })
                    .catch(err => console.error('Error clearing login flag:', err));
            };
        };
        
        // Check if noticeboard modal exists and is showing
        if (noticeBoardModal) {
            // Use a small delay to let noticeboard modal initialize
            setTimeout(function() {
                const bsModal = bootstrap.Modal.getInstance(noticeBoardModal);
                if (bsModal && bsModal._isShown) {
                    // Noticeboard is showing, wait for it to close
                    noticeBoardModal.addEventListener('hidden.bs.modal', function() {
                        // Wait a moment for the noticeboard modal to fully close, then show AAC modal
                        setTimeout(showAACModal, 500);
                    }, { once: true }); // Use once so it only fires once
                } else {
                    // Noticeboard not showing, show AAC modal immediately
                    showAACModal();
                }
            }, 100); // Small delay to let noticeboard modal initialize
        } else {
            // No noticeboard modal exists, show AAC modal immediately
            showAACModal();
        }
    });
    {% endif %}
</div>
{% endblock %}