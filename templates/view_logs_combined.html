<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Logs</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 30px;
    }
    th, td {
      padding: 8px 12px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f5f5f5;
    }
    .form-section {
      margin-bottom: 20px;
    }
    label {
      font-weight: bold;
      margin-right: 10px;
    }
    input, select {
      padding: 5px;
      margin-right: 10px;
    }
  </style>
</head>
<body>

  {% include 'header.html' %}

  <h1>Care Log Analysis</h1>

  <form method="get" action="/view-logs" class="form-section">
    <label for="activity">Activity:</label>
    <select name="activity" id="activity">
      <option value="">-- All Activities --</option>
      <option value="Mood">Mood</option>
      <option value="Sleep Quality">Sleep Quality</option>
      <option value="Nap Taken">Nap Taken</option>
      <option value="Toilet Success">Toilet Success</option>
      <option value="Accidents">Accidents</option>
      <option value="Bath/Shower Completed">Bath/Shower Completed</option>
      <option value="Teeth Brushed">Teeth Brushed</option>
      <option value="Walking Ability">Walking Ability</option>
      <option value="Motor Skills">Motor Skills</option>
      <option value="Communication Level">Communication Level</option>
      <option value="Fluid Intake">Fluid Intake</option>
      <option value="Nappy Changes">Nappy Changes</option>
      <option value="Meltdowns">Meltdowns</option>
      <option value="Sensory Sensitivities">Sensory Sensitivities</option>
    </select>

    <label for="start_date">From:</label>
    <input type="date" name="start_date" id="start_date">

    <label for="end_date">To:</label>
    <input type="date" name="end_date" id="end_date">

    <button type="submit">Filter</button>
  </form>



  <h2>Log Entries</h2>
  <table>
    <thead>
      <tr>
        <th>Date & Time</th>
        <th>Carer</th>
        <th>Activity</th>
        <th>Activity Type</th> 
        <th>Value</th>
        <th>Value Type</th>
        <th>Notes</th>
        <th>Duration</th>
        <th>Edit</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
        <tr>
          <td>{{ log.activity_datetime.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ log.carer_name }}</td>
          <td>{{ log.activity_name }}</td>
          <td>{{ log.activity_type or '' }}</td>
          <td>{{ log.value }}</td>
          <td>{{ log.display_value }}</td>
          <td>{{ log.notes }}</td>
          <td>{{ log.duration or '' }}</td>
          <td><a href="{{ url_for('edit_log', log_id=log.id) }}">Edit</a></td>
        </tr>
      {% else %}
        <tr>
          <td colspan="9">No entries found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ðŸ‘‡ Moved to here: Combined Chart after the table -->
  <canvas id="logChartCombined" height="100" class="mt-5"></canvas>

  <script type="application/javascript">
    const ctxCombined = document.getElementById('logChartCombined').getContext('2d');
    const combinedDatasets = {{ combined_datasets | tojson | safe }};

    new Chart(ctxCombined, {
      type: 'line',
      data: {
        datasets: combinedDatasets
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Combined Activity Timeline'
          },
          tooltip: {
            mode: 'index',
            intersect: false,
          },
          legend: {
            position: 'top',
          }
        },
        interaction: {
          mode: 'nearest',
          axis: 'x',
          intersect: false
        },
        scales: {
          x: {
            type: 'time',
            time: {
              parser: 'YYYY-MM-DD HH:mm',
              tooltipFormat: 'll HH:mm'
            },
            title: {
              display: true,
              text: 'Date/Time'
            }
          },
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Value'
            }
          }
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
